<!-- Add Vendor to Product button -->
<a class="btn btn-outline-success btn-block" data-toggle="modal" data-target="#addvendor-{{ record.pk }}" href="#">
    <i class="fas fa-user-plus"></i> Add Vendor to Product
</a>

<!-- Add Vendor to Product Modal -->
<div class="modal fade" id="addvendor-{{ record.pk }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"><div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
                <i class="fas fa-user-plus"></i> 
                    Add Vendor to ->
                <i style="font-weight:800">{{ record.name }} </i>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
        <form method="post" action="{% url 'products_listing_post' %}">
        {% csrf_token %}
        <select name="vendor" id="vendor" class="form-control form-control-lg">
            <option value="">Select Vendor</option>
            {% for vendor in vendors %}
                {% if record.vendorproduct_set.all %}
                    {% for vendorproduct in record.vendorproduct_set.all %}
                        {% if vendorproduct.vendor == vendor %}
                        {% else %}
                            <option data-unit="{{ record.unit }}" data-product_id="{{ record.pk }}" data-vendor_contact_id="{{ vendor.contact_id }}" data-payment_terms="{{ vendor.payment_terms }}" data-place_of_contact="{{ vendor.place_of_contact }}">{{ vendor.contact_name }}</option>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <option data-unit="{{ record.unit }}" data-product_id="{{ record.pk }}" data-vendor_contact_id="{{ vendor.contact_id }}" data-payment_terms="{{ vendor.payment_terms }}" data-place_of_contact="{{ vendor.place_of_contact }}">{{ vendor.contact_name }}</option>
                {% endif %}
            {% endfor %}
            
        </select>
        <table class="table table-bordered mt-3" id="addvendor-{{ record.pk }}">
        </table>
        </div>
        <div class="modal-footer">
             <input type="submit" name="add_vendor" value="Add Vendor" title="Add Vendor to the Product" class="btn btn-outline-success btn-lg btn-block">
        </div>
             </form>
        </div>
    </div>
</div>
{% for vendorproduct in record.vendorproduct_set.all %}
    <div class="card m-1">
        <header class="card-header">


            <a href="#" data-toggle="collapse" data-target="#vendorproduct-{{ vendorproduct.id }}"  class="btn btn-sm   btn-outline-primary m-1">
                <span class="title">{{ vendorproduct.vendor.contact_name }}</span>
            </a>

            <!-- Delete Vendor From Product Button -->
            <a href="#" class="btn btn-sm btn-outline-danger m-1" style="float:right" data-toggle="modal"   data-target="#deletevendor-{{ vendorproduct.id }}" title="Delete Vendor From {{ vendorproduct.product.name }}">
                <i class="fas fa-trash-alt"></i>
            </a>
            <!-- Delete Vendor From Product Modal -->
            <div class="modal fade" id="deletevendor-{{ vendorproduct.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">    
                            <h5 class="modal-title" id="exampleModalLabel">
                                <i class="fas fa-trash-alt"></i>-Delete vendor from 
                                <i>{{ vendorproduct.product.name }}</i>
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>    
                            </button>  
                        </div>  
                        <div class="modal-body">Delete Vendor from {{ vendorproduct.product.name }} form</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <form action="{% url 'products_listing_post' %}" method="post">
                                {% csrf_token %}
                            <button type="submit" class="btn btn-primary inline">Save changes</button>
                                <input style="display: none" name="delete_vendorproduct" value="{{ vendorproduct.id }}" type="text">
                                </form>
                        </div>
                    </div>
                </div>
            </div> 

            <!-- Add Product Variation Button -->
            <a href="#" class="btn btn-sm btn-outline-success m-1" data-toggle="modal" data-target="#addproductvariation-{{ vendorproduct.id }}" style="float:right" title="Add Product Variation From {{ vendorproduct.vendor.contact_name }}">
                <i class="fas fa-plus"></i>
            </a>

            <!-- Add Product Variation Modal -->
            <div class="modal fade" id="addproductvariation-{{ vendorproduct.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                                <i class="fas fa-plus"></i> Add Variation of {{ vendorproduct.product.name }} to

                                <i style="color:red;">{{ vendorproduct.vendor.contact_name }}</i>
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                         <form method="post" action="{% url 'products_listing_post' %}">
                            {% csrf_token %}
                                <div class="container">
                                    <div class="row form-group">
            
                                        <table class="table table-bordered" >
                                            <tr>
                                                <td class="table-secondary">Vendor:</td>
                                                <td>{{ vendorproduct.vendor.contact_name }}</td>
                                            </tr>
                                            <tr>
                                                <td class="table-secondary">Make:</td>
                                                <td>{{ vendorproduct.product.make }}</td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Product ID (ZOHO):</td>
                                              <td>{{ vendorproduct.product.item_id }}</td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Product Group:</td>
                                              <td>{{ vendorproduct.product.group }}</td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Label Name:</td>
                                              <td><input name="label_name" type="text" class="form-control"></td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Delivery Terms:</td>
                                              <td class="form-group">
                                                <select class="form-control" id="delivery-terms" name="delivery_terms">
                                                  <option value="Door Deliver">Door Deliver</option>
                                                  <option value="Ex-Godown">Ex-Godown</option>
                                                  <option value="FOR">FOR</option>
                                                  <option value="Local Transport">Local Transport</option>
                                                </select>
                                              </td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Quantity:</td>
                                              <td>
                                                <input type="number" name="quantity" step="0.01" class="form-control" required>({{ vendorproduct.product.unit }})
                                              </td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Specifications:</td>
                                              <td><input type="text" name="specs"  class="form-control" ></td>
                                            </tr>
                                            <tr>
                                              <td class="table-secondary">Vendor Price (INR):</td>
                                              <td><input type="number" name="price" step="0.01" class="form-control" required></td>
                                            </tr>
                                            <tr>
                                                <td class="table-secondary">Expiry Date:</td>
                                                <td class="form-group">
                                                    <input type="date" name="expiry" step="0.01" class="form-control" required>
                                                    <input type="hidden" name="product_id" value="{{ vendorproduct.product.item_id }}">
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="submit" name="add_product_variation" value="Add Product Variation to {{ vendorproduct.product.name }}" title="Add Product To Vendor" class="btn btn-outline-success btn-block">
                        </form>
                            </div>
                        
                    </div>
                </div>
            </div>

            <!-- Vendor Profile Link -->
            <a href="{% url "vendor_profile" vendorproduct.vendor.contact_id %}" title="Vendor Profile of {{ vendorproduct.vendor.contact_name }}" class="btn btn-sm btn-outline-warning m-1" style="float:right">
                <i class="fas fa-user"></i>
            </a>
            <br>
            <span style="float:left;" class="m-1">
                <strong>Location:</strong>{{ vendorproduct.vendor.place_of_contact }} 
            </span>
            <span style="float:right;" class="m-1">
                <strong>Payment Terms:</strong>{{ vendorproduct.vendor.payment_terms }}
            </span>
        </header>
        <div class="collapse show" id="vendorproduct-{{ vendorproduct.id }}" style="">
            <article class="card-body px-0 py-0" style="font-size:10px"> 
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Specs</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Price</th>
                            <th scope="col">Last Updated</th>
                            <th scope="col">Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for variation in vendorproduct.vendorproductvariation_set.all %}
                            <tr class="{% if variation.dealvendorproduct.expiry_status > 0 %}table-success{% elif variation.dealvendorproduct.expiry_status == 0 %} table-warning {% else %} table-danger {% endif %}">
                                <th scope="row">Variation-{{ forloop.counter }}</th>
                                <td>{{ variation.dealvendorproduct.specs }}</td>
                                <td>{{ variation.dealvendorproduct.quantity }}</td>
                                <td style="font-weight:800">{{ variation.dealvendorproduct.vendor_price }}</td>
                                <td style="font-size:10px;">{{ variation.dealvendorproduct.deal.time_created |date:"jS F,Y H:i" }}
                                    <br>
                                    <span style="float:right;font-style:italic;font-size:9px"> 
                                        -By {{ variation.dealvendorproduct.deal.created_by.first_name }} {{ variation.dealvendorproduct.deal.created_by.last_name }} 
                                    </span>
                                </td>
                                <td>
                                    <!-- Delete Product Variation Button -->
                                    <a class="btn btn-danger btn-block btn-sm m-1" href="#" style="" data-toggle="modal" data-target="#deletevariation-{{ variation.id }}" title="Delete Variation of {{ variation.dealvendorproduct.product.name }}">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                    <!-- Delete Product Variation Button -->
                                    <div class="modal fade" id="deletevariation-{{ variation.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel">
                                                        <i class="fas fa-trash"></i>- Delete this variation of {{ variation.dealvendorproduct.product.name }} ?
                                                    </h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body"> 
                                                    Delete this variation of {{ variation.dealvendorproduct.product.name }} Form 
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                    <form action="{% url 'products_listing_post' %}" method="post">
                                                        {% csrf_token %}
                                                    <button type="submit" class="btn btn-primary inline-group">Save changes</button>
                                                        <input name="delete_variation" style="display: none" value="{{ variation.id }}">
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Update Variation Button -->
                                    <a class="btn btn-warning btn-block btn-sm m-1" data-toggle="modal" data-target="#updatevariation-{{ variation.id }}" href="#">
                                        <i class="fas fa-arrow-up"></i> Update
                                    </a>

                                    <!-- Update Variation Modal -->
                                    <div class="modal fade" id="updatevariation-{{ variation.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel">
                                                        <i class="fas fa-arrow-up"></i> - Update Variation of {{ variation.dealvendorproduct.product.name }}
                                                    </h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="post" action="{% url 'products_listing_post' %}">
                                                            {% csrf_token %}
                                                        <div class="container">
                                                            <div class="row form-group">
            
                                                                <table class="table table-bordered" >
                                                                    <tr>
                                                                      <td class="table-secondary">Product:</td>
                                                                      <td>{{ vendorproduct.product.name }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Make:</td>
                                                                      <td>{{ vendorproduct.product.make }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Product ID (ZOHO):</td>
                                                                      <td>{{ vendorproduct.product.item_id }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Product Group:</td>
                                                                      <td>{{ vendorproduct.product.group }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Label Name:</td>
                                                                      <td><input name="label_name" type="text" class="form-control" value="{{ variation.dealvendorproduct.label_name }}" disabled></td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Old Delivery Terms:</td>
                                                                      <td><input name="label_name" type="text" class="form-control" value="{{ variation.dealvendorproduct.deal.delivery_terms }}" disabled></td>
                                                                    </tr>

                                                                    <tr>
                                                                      <td class="table-secondary">New Delivery Terms:</td>
                                                                      <td class="form-group">
                                                                        <select class="form-control" id="delivery-terms" name="delivery_terms">
                                                                          <option value="Door Deliver" {% if variation.dealvendorproduct.deal.delivery_terms == "Door Deliver" %}selected{% endif %}>Door Deliver</option>
                                                                          <option value="Ex-Godown" {% if variation.dealvendorproduct.deal.delivery_terms == "Ex-Godown" %}selected{% endif %}>Ex-Godown</option>
                                                                          <option value="FOR" {% if variation.dealvendorproduct.deal.delivery_terms == "FOR" %}selected{% endif %}>FOR</option>
                                                                          <option value="Local Transport" {% if variation.dealvendorproduct.deal.delivery_terms == "Local Transport" %}selected{% endif %}>Local Transport</option>
                                                                        </select>
                                                                      </td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Quantity:</td>
                                                                      <td><input type="number" name="quantity" value="{{ variation.dealvendorproduct.quantity }}" step="0.01" class="form-control" disabled>({{ vendorproduct.product.unit }})</td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Specifications:</td>
                                                                      <td><input type="text" name="specs" value="{{ variation.dealvendorproduct.specs }}" class="form-control" disabled></td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Old Vendor Price (INR):</td>
                                                                      <td><input type="number"  value="{{ variation.dealvendorproduct.vendor_price }}" step="0.01" class="form-control" disabled></td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">New Vendor Price (INR):</td>
                                                                      <td><input type="number" name="newprice" step="0.01" class="form-control" required></td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Expiry Status</td>
                                                                      <td><input type="text" value="{{ variation.dealvendorproduct.expiry_status }}" step="0.01" class="form-control" disabled></td>
                                                                    </tr>
                                                                    <tr>
                                                                      <td class="table-secondary">Expiry Date:</td>
                                                                      <td class="form-group"><input type="date" name="expiry" step="0.01" class="form-control" required><input type="hidden" name="dealproduct_id" value="{{ variation.dealvendorproduct.id }}"><input type="hidden" name="contact_id" value="{{ variation.dealvendorproduct.deal.vendor.contact_id }}"></td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <input type="submit" name="update_product" value="Update {{ vendorproduct.product.name }} Variation-{{ forloop.counter }}" title="Update Product Variation From Vendor" class="btn btn-outline-warning btn-lg btn-block">
                                                        </form>
        
                                                    </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <p style="font-size:9px;color:black;font-weight:800;" class="my-1">
                                        {% if variation.dealvendorproduct.expiry_status == 0 %} 
                                            Price will expire TODAY 
                                        {% elif variation.dealvendorproduct.expiry_status < 0%} 
                                            Price Expired {% widthratio variation.dealvendorproduct.expiry_status 1 -1 %} Day(s) ago.
                                        {% else %} 
                                            Deal will expire in {{ variation.dealvendorproduct.expiry_status }} Day(s).
                                        {% endif %}
                                    </p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </article>
        </div>
    </div>
{% endfor %}
