{% extends 'home.html' %}
{% block page-title-var %} Estimates From Zoho {% endblock page-title-var %}


{% block application-active %}


<div class="container">
  <div class="row">
    <div class="col-md-12">
      <nav>
        <div class="container">
          <a href="{% url 'update_zoho_estimates' %}" style="display: table;margin-right: auto;margin-left: auto" class="btn btn-outline-primary">
            Update Estimates From Zoho
          </a>
          <br>
          <br>
        </div>
        <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
          <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#estimate-unquoted" role="tab" aria-controls="nav-home" aria-selected="true">Unquoted</a>
          <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#estimate-quoted" role="tab" aria-controls="nav-profile" aria-selected="false">Quoted</a>
          <a class="nav-item nav-link" id="nav-contact-tab" data-toggle="tab" href="#estimate-accepted" role="tab" aria-controls="nav-contact" aria-selected="false">Accepted</a>
        </div>
      </nav>
      <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="estimate-unquoted" role="tabpanel" aria-labelledby="nav-home-tab">
          <div class="alert alert-danger" role="alert">
            <p>These are the drafted queries from ZOHO ESTIMATES. To Start working on an ESTIMATE:</p>
            <ol>
              <li>Click On Edit Button</li>
              <li>Select the available purchase prices.(Leave it unselected if no active purchase prices are available)</li>
              <li>Submit to save purchase prices and send notification mail to Sales Team</li>
            </ol>
          </div>
                            <table class="table table-striped table-bordered " style="width:100%" data-toggle="table" data-sort-name="date" data-sort-order="desc">
                              <thead>
                                <tr>
                                  <th>Estimate Number</th>
                                  <th>Buyer</th>
                                  <th>Sales Person</th>
                                  <th>Status</th>
                                  <th>Date</th>
                                  <th>Expiry Date</th>
                                  <th>Delivery Terms</th>
                                  <th>Total</th>
                                  
                                  <th>Quote </th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for estimate in estimates %}
                                {% if estimate.tool_status == '' %}
                                <tr>
                                  <td><a href='#' onClick="window.open('{{ estimate.estimate_url }}', 'estimate','width=600,height=400')" class='btn btn-outline-primary btn-sm'>{{ estimate.estimate_number }} </a></td>
                                  <td> 
                                    <a style="max-width:100%;white-space:normal;" class="btn btn-outline-info" href="{% url 'buyer_profile' contact_id=estimate.buyer.contact_id %}">
                                      {{ estimate.buyer }}
                                    </a>  
                                  </td>
                                  <td>  
                                    {{ estimate.salesperson }}  
                                  </td>
                                  <td> {{ estimate.status }}</td>
                                  <td>{{ estimate.date }} </td>
                                  <td>{{ estimate.expiry_date }}</td>
                                  <td> {{ estimate.delivery_terms }} </td>
                                  <td>{{ estimate.total }} </td>
                                  
                                  <td>
                                    <a href="{% url 'zoho_estimate' pk=estimate.estimate_id %}" class='btn btn-outline-primary btn-sm'>Quote</a>
                                  </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                              </tbody>
                              <tfoot>
                                <tr>
                                  <th>Estimate Number</th>
                                  <th>Buyer</th>
                                  <th>Sales Person</th>
                                  <th>Status</th>
                                  <th>Date</th>
                                  <th>Expiry Date</th>
                                  <th>Delivery Terms</th>
                                  <th>Total</th>
                                  
                                  <th>Quote</th>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                          <div class="tab-pane fade" id="estimate-quoted" role="tabpanel" aria-labelledby="nav-profile-tab">
                            <div class="alert alert-warning" role="alert">
                            <p>These are the ZOHO ESTIMATES for which purchase prices of the products to be selected.</p>
                            <ul>
                              <li>Click On Edit Button</li>
                              <li>Select the available purchase prices.(Leave it unselected if no active purchase prices are available)</li>
                              <li>Submit to save purchase prices.</li>
                              <li>Once all the products of an ESTIMATE has a purchase price. It will move to [ Ready to be sent ]</li>
                              <li>List of products which do not have purchase price can be checked <a href="{% url 'estimate_products' %}" class="btn btn-sm btn-outline-info"> HERE </a></li>
                            </ul>
                          </div>
                          <table class="table table-striped table-bordered " style="width:100%" data-toggle="table" data-sort-name="date" data-sort-order="desc">
                            <thead>
                              <tr>
                                <th>Estimate Number</th>
                                <th>Buyer</th>
                                <th>Sales Person</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Expiry Date</th>
                                <th>Delivery Terms</th>
                                <th>Product Status</th>
                                <th>Move Back To Drafted</th>
                               
                                <th>Re-Quote </th>
                                <th>View </th>
                              </tr>
                            </thead>
                            <tbody>
          {% for estimate in estimates %}
            {% if estimate.status != 'accepted' %}
              {% if estimate.tool_status == 'in-progress' %}
                <tr>
                  <td><a href='#' onClick="window.open('{{ estimate.estimate_url }}', 'estimate','width=600,height=400')" class='btn btn-outline-primary btn-sm'> {{ estimate.estimate_number }} </a></td>
                  <td> <a style="max-width:100%;white-space:normal;" class="btn btn-outline-info" href="{% url 'buyer_profile' contact_id=estimate.buyer.contact_id %}">{{ estimate.buyer }}</a>   </td>
                  <td>  {{ estimate.salesperson }}  </td>
                  <td> {{ estimate.status}}</td>
                  <td>{{ estimate.date }} </td>
                  <td>{{ estimate.expiry_date }}</td>
                  <td> {{ estimate.delivery_terms }} </td>
                  <td>
                    <span style="color:red;font-weight:bolder;">{{ estimate.products_left }}</span> Products left  out of <span style="color:red;font-weight:bolder;">{{ estimate.total_products }}</span> Products.
                  </td>
                  <td>
                    <a class="btn btn-danger btn-sm" data-toggle="modal"  href="#" data-target="#estimate-{{ estimate.estimate_number }}">
                      <i class="fas fa-arrow-left"></i> Move back to Draft
                    </a>
                  <!-- Modal -->
                    <div class="modal fade" id="estimate-{{ estimate.estimate_number }}" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                              <i class="fas fa-undo-alt"></i>- Move Estimate# - 
                              <span style="color:red">{{ estimate.estimate_number }}</span> from 
                              <span style="color:red;">{{ estimate.buyer.contact_name }}</span> back to draft ?
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            <table class="table table-bordered table-sm">
                              <tr>
                                <td class="table-secondary">Estimate Number</td>
                                <td>{{ estimate.estimate_number }}</td>
                                <td class="table-secondary">Buyer</td>
                                <td>{{ estimate.buyer.contact_name }}</td>
                              </tr>
                              <tr>
                                <td class="table-secondary">Date Received</td>
                                <td>{{ estimate.date }}</td>
                                <td class="table-secondary">Buyer Payment Terms</td>
                                <td>{{ estimate.buyer.payment_terms }}</td>
                              </tr>
                            </table>
                            <hr>
                            <table class="table">
                              <thead class="thead-dark">
                                <tr>
                                  <th scope="col">Product</th>
                                  <th scope="col">Make</th>
                                  <th scope="col">Quantity</th>
                                  <th scope="col">Pack Size</th>
                                  <th scope="col">Purchase Price</th>
                                  <th scope="col">Freight</th>
                                  <th scope="col">Selling Price</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for item in estimate.estimateproduct_set.all %}
                                  <tr class="{% if item.vendorproductvariation %} table-success {% else %} table-danger {% endif %}">
                                    <th scope="row">{{ item.product.name }}</th>
                                    <td>{{ item.product.make }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.pack_size }}</td>
                                    {% if item.vendorproductvariation %}
                                      <td>{{ item.vendorproductvariation.dealvendorproduct.vendor_price }}</td>
                                      <td>{{ item.vendorproductvariation.vendorproduct.vendor.freight_per_kg }}</td>
                                      <td>{{ item.selling_price }}</td>
                                    {% endif %}
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                          <div class="modal-footer" style="display:block">
                            <form method="post" action="">
                            {% csrf_token %}
                              <input type="hidden" name="estimate_id" value="{{ estimate.estimate_id }}">
                              <input type="submit" class="btn btn-outline-danger btn-block btn" name="move_to_draft" value="Move Estimate# {{ estimate.estimate_number }} back to Draft" />
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                
                <td>  
                  <a href="{% url 'zoho_estimate_inprogress' pk=estimate.estimate_id %}" class='btn btn-outline-primary btn-sm'>Re-Quote</a>
                </td>
                <td>
                  <a class="btn btn-success btn-sm btn-block" data-toggle="modal" data-target="#send-{{ estimate.estimate_number }}" href="#">
                    Quick View <i class="fas fa-step-forward"></i>
                  </a>
                  
                  <div  class="modal fade" id="send-{{ estimate.estimate_number }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg" style="max-width:89%;" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel"> 
                            <i class="fas fa-envelope"></i> Quoted Estimate to 
                            <span style="color:red">{{ estimate.buyer.contact_name }}</span>
                          </h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <table class="table table-bordered table-sm">
                            <tr>
                              <td class="table-secondary">Estimate Number</td>
                              <td>
                                <a href="#" class="btn btn-outline-primary btn-sm" onclick="window.open('https://books.zoho.com/app#/quotes/{{ estimate.estimate_id }}','product_history','width=600,height=400')">{{ estimate.estimate_number }}</a>
                              </td>
                              <td class="table-secondary">Buyer</td>
                              <td>{{ estimate.buyer.contact_name }}</td>
                            </tr>
                            <tr>
                              <td class="table-secondary">Date Received</td>
                              <td>{{ estimate.date }}</td>
                              <td class="table-secondary">Buyer Payment Terms</td>
                              <td>{{ estimate.buyer.payment_terms }}</td>
                            </tr>
                          </table>
                          <hr>
                          <table class="table">
                            <thead class="thead-dark">
                              <tr>
                                <th scope="col">Product</th>
                                <th scope="col">Make</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Pack Size</th>
                                <th scope="col">Purchase Price</th>
                                <th scope="col">Vendor Freight</th>
                                <th scope="col">Customer Freight</th>
                                <th scope="col">Selling Price</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for item in estimate.estimateproduct_set.all %}
                                <tr class="{% if item.vendorproductvariation %} table-success {% else %} table-danger {% endif %}">
                                  <th scope="row">{{ item.product.name }}</th>
                                  <td>{{ item.product.make }}</td>
                                  <td>{{ item.quantity }}</td>
                                  <td>{{ item.pack_size }}</td>
                                {% if item.vendorproductvariation %}
                                  <td>{{ item.vendorproductvariation.dealvendorproduct.vendor_price }}</td>
                                  <td>{{ item.vendorproductvariation.vendorproduct.vendor.freight_per_kg }}</td>
                                  <td>{{ estimate.buyer.freight_per_kg }}</td>
                                  <td>{{ item.selling_price }}</td>
                                {% endif %}
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        <div class="modal-footer" style="display:block">
                          <div class="alert alert-warning" role="alert">
                            <p> To Quote and Send Estimate to <span style="color:red;">{{ estimate.buyer }}</span>
                              <a href="#" class="btn btn-outline-primary btn-sm" onclick="window.open('https://books.zoho.com/app#/quotes/{{ estimate.estimate_id }}/edit','product_history','width=600,height=400')">Click Here</a> and:
                            </p>
                            <ul>
                              <li>Quote the product prices equal to or more than the Selling Price Above</li>
                              <li>After Quoting the prices Send the Estimate to {{ estimate.buyer }} from ZOHO.</li>
                              <li>Now <a href="{% url 'update_zoho_estimates' %}" class="btn btn-outline-primary btn-sm">Click here</a> to Update Estimate Status</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <a data-toggle="modal" data-target="#margin-{{ estimate.estimate_id }}" data-id="{{ estimate.estimate_id }}" class="btn btn-outline-success btn-block btn-sm estimate-margin">
                    <i class="fas fa-money-check-alt"></i> 
                      Check Margin 
                  </a>
                  <div class="modal fade" id="margin-{{ estimate.estimate_id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg estimate-margin-modal" style="max-width:80%;width:100%" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="exampleModalLabel">
                            <i class="fas fa-money-check-alt"></i>- Check Margin 
                          </h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
            </tr>
            {% endif %}
            {% endif %}
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
              <th>Estimate Number</th>
              <th>Buyer</th>
              <th>Sales Person</th>
              <th>Status</th>
              <th>Date</th>
              <th>Expiry Date</th>
              <th>Delivery Terms</th>
              <th>Product Status</th>
              <th>Move Back To Drafted</th>
              
              <th>Re-Quote</th>
              <th>View</th>


            </tr>
        </tfoot>
    </table>
                          </div>
                          <div class="tab-pane fade" id="estimate-accepted" role="tabpanel" aria-labelledby="nav-contact-tab">
                            <table class="table table-striped table-bordered " style="width:100%" data-toggle="table" data-sort-name="date"   data-sort-order="desc">
        <thead>
            <tr>
              <th>Estimate Number</th>
              <th>Buyer</th>
              
              <th>Sales Person</th>
              <th>Status</th>
              <th>Date</th>
              <th>Expiry Date</th>
              <th>Delivery Terms</th>
              <th>Total</th>
              <th>Check Margin</th>
            </tr>
          </thead>
          <tbody>
            {% for estimate in estimates %}
              {% if estimate.status == 'accepted' and estimate.tool_status == 'in-progress' %}
                <tr>
                  <td>{{ estimate.estimate_number }}</td>
                  <td> <a  style="max-width:100%;white-space:normal;" class="btn btn-outline-info" href="{% url 'buyer_profile' contact_id=estimate.buyer.contact_id %}">{{ estimate.buyer }}</a> </td>
                  <td>  {{ estimate.salesperson }}  </td>
                  <td> {{ estimate.status }}</td>
                  <td>{{ estimate.date }} </td>
                  <td>{{ estimate.expiry_date }}</td>
                  <td> {{ estimate.delivery_terms }} </td>
                  <td>{{ estimate.total }} </td>
                  <td>
                    <a data-toggle="modal" data-target="#margin-{{ estimate.estimate_id }}" data-id="{{ estimate.estimate_id }}" class="btn btn-outline-success btn-block btn-sm estimate-margin">
                      <i class="fas fa-money-check-alt"></i> 
                      Check Margin and Create Sales Order
                    </a>
                    <div class="modal fade" id="margin-{{ estimate.estimate_id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-lg estimate-margin-modal" style="max-width:80%;width:100%" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">
                              <i class="fas fa-money-check-alt"></i>- Check Margin And Create Sales Order For {{ estimate.estimate_number }}
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          <div class="modal-body">
                            
                          </div>
                          <div class="modal-footer" style="display:block">
                            <div class="alert alert-primary" role="alert">
                                <p style="text-align:center;color:black;"><a href='#' onClick="window.open('https://books.zoho.com/app#/salesorders/new?estimate_id={{ estimate.estimate_id }}', 'estimate_to_sales_order','width=600,height=400')"   class='btn btn-outline-success btn-sm'>Click Here</a> to convert the estimate to Sales Order</p>
                            </div>
                            
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                  
                  
              </tr>
              {% endif %}
              {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th>Estimate Number</th>
              <th>Buyer</th>
              <th>Sales Person</th>
              <th>Status</th>
              <th>Date</th>
              <th>Expiry Date</th>
              <th>Delivery Terms</th>
              <th>Total</th>
                
                
              <th>Check Margin</th>



            </tr>
          </tfoot>
      </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
      
      
      
    </div>
    
  
      
    </div>
    <div class="tab-pane fade" id="pills-po" role="tabpanel" aria-labelledby="pills-po-tab">
      <table class="table table-striped table-bordered " style="width:100%" data-toggle="table" data-sort-name="date"   data-sort-order="desc">
          <thead>
              <tr>
                <th>Estimate Number</th>
                <th>Buyer</th>
                <th>Status</th>
                <th>Date</th>
                <th>Expiry Date</th>
                <th>Delivery Terms</th>
                <th>Total</th>
                <th>Check Margin</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot>
            <tr>
              <th>Estimate Number</th>
              <th>Buyer</th>
              <th>Status</th>
              <th>Date</th>
              <th>Expiry Date</th>
              <th>Delivery Terms</th>
              <th>Total</th>
              <th>Check Margin</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
<script>
$('.salesorder-margin').click(
  function(){
  var salesorder_id = ($(this).data('id'));
  $('#margin-'+salesorder_id).find('.modal-body').html("<img style='display:block;margin:auto;' src='https://loading.io/spinners/flickr/index.orbit-balls-loading-gif.gif' />");
  $.ajax({
    url: '../../../../../ajax/salesorder-margin',
    type: "get",
    data: {'slug': salesorder_id },
    success: function(data) {
      $('#margin-'+salesorder_id).modal('show');
      $('#margin-'+salesorder_id).find('.modal-body').html(data.salesorder_margin_snippet);
    },
    error: function(err) {
      console.log('error', err);
      }
    })
                //});
});
$('.estimate-margin').click(
  function(){
  var estimate_id = ($(this).data('id'));
  $('#margin-'+estimate_id).find('.modal-body').html("<img style='display:block;margin:auto;' src='https://loading.io/spinners/flickr/index.orbit-balls-loading-gif.gif' />");
  $.ajax({
    url: '../../../../../ajax/estimate-margin',
    type: "get",
    data: {'slug': estimate_id },
    success: function(data) {
      $('#margin-'+estimate_id).modal('show');
      $('#margin-'+estimate_id).find('.modal-body').html(data.margin_snippet);
    },
    error: function(err) {
      console.log('error', err);
      }
    })
                //});
});
</script>
{% endblock application-active %}
